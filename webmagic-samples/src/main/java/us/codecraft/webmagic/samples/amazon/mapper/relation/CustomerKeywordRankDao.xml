<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="us.codecraft.webmagic.samples.amazon.dao.relation.CustomerKeywordRankDao">
    <resultMap id="CustomerRankKeywordMap" type="CustomerKeywordRank">
        <id column="rcrk_id" property="id" />
        <result column="saa_asin" property="asin" />
        <result column="rcrk_keyword" property="keyword" />
        <result column="bec_code" property="customerCode" />
        <result column="bas_code" property="siteCode" />
        <result column="bad_code" property="departmentCode" />
        <result column="rcrk_crawl" property="crawl" />
        <result column="rcrk_priority" property="priority" />
        <result column="rcrk_frequency" property="frequency" />
        <result column="rcrk_sync_time" property="syncTime" />
        <result column="rcrk_create_time" property="createTime" />
        <result column="rcrk_update_time" property="updateTime" />
    </resultMap>

    <insert id="add" parameterType="CustomerKeywordRank" keyProperty="id" useGeneratedKeys="true">
        INSERT INTO relation_customer_rank_keyword (
          saa_asin,
          rcrk_keyword,
          bec_code,
          bas_code,
          bad_code,
          rcrk_crawl,
          rcrk_priority,
          rcrk_frequency,
          rcrk_create_time,
          rcrk_update_time
        ) VALUES (
          #{asin},
          #{keyword},
          #{customerCode},
          #{siteCode},
          #{departmentCode},
          #{crawl},
          #{priority},
          #{frequency},
          CURRENT_TIMESTAMP,
          CURRENT_TIMESTAMP
        )
    </insert>

    <insert id="addAll" parameterType="java.util.List">
        INSERT INTO relation_customer_rank_keyword (
          saa_asin,
          rcrk_keyword,
          bec_code,
          bas_code,
          bad_code,
          rcrk_crawl,
          rcrk_priority,
          rcrk_frequency,
          rcrk_create_time,
          rcrk_update_time
        ) VALUES
        <foreach collection="list" index="index" item="item" separator=",">
          (
            #{item.asin},
            #{item.keyword},
            #{item.customerCode},
            #{item.siteCode},
            #{item.departmentCode},
            #{item.crawl},
            #{item.priority},
            #{item.frequency},
            CURRENT_TIMESTAMP,
            CURRENT_TIMESTAMP
          )
        </foreach>
    </insert>

    <update id="update" parameterType="CustomerKeywordRank">
        UPDATE
          relation_customer_rank_keyword
        SET
          saa_asin = #{asin},
          rcrk_keyword = #{keyword},
          bec_code = #{customerCode},
          bas_code = #{siteCode},
          bad_code = #{departmentCode},
          rcrk_crawl = #{crawl},
          rcrk_priority = #{priority},
          rcrk_frequency = #{frequency},
          rcrk_sync_time = #{syncTime},
          rcrk_update_time = CURRENT_TIMESTAMP
        WHERE
          rcrk_id = #{id}
    </update>

    <select id="findByCustomer" resultMap="CustomerRankKeywordMap" parameterType="java.lang.String">
        SELECT
          *
        FOR
          relation_customer_rank_keyword
        WHERE
          bec_code = #{0}
    </select>
    <select id="findNeedGenerateBatch" resultMap="CustomerRankKeywordMap">
        SELECT
          *
        FROM
          relation_customer_rank_keyword
        WHERE
          rcrk_crawl = 1 AND
          CURRENT_TIMESTAMP - rcrk_sync_time > rcrk_frequency * 3600
          OR rcrk_sync_time is null;
    </select>
    <select id="findCustomerCodeIsOpen" resultMap="CustomerRankKeywordMap">
        SELECT
          *
        FOR
          relation_customer_rank_keyword
        WHERE
          rcrk_crawl = 1 AND bec_code = #{0}
    </select>

    <select id="findByObj" resultMap="CustomerRankKeywordMap">
        SELECT
          *
        FROM
          relation_customer_rank_keyword
        WHERE
          saa_asin = #{asin} AND rcrk_keyword = #{keyword} AND bec_code = #{customerCode} AND bas_code = #{siteCode} AND bad_code = #{departmentCode}
    </select>
</mapper>