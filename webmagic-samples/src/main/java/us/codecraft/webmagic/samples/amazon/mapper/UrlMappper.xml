<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="us.codecraft.webmagic.samples.amazon.dao.UrlDao">

    <resultMap id="UrlResultMap" type="Url">
        <result property="id" column="sau_id"/>
        <result property="urlMD5" column="sau_url_md5"/>
        <result property="batchNum" column="bo_batch_num"/>
        <result property="type" column="sau_type"/>
        <result property="siteCode" column="bas_code"/>
        <result property="asin" column="saa_asin"/>
        <result property="reviewId" column="sau_review_id"/>
        <result property="status" column="sau_status"/>
        <result property="crawling" column="sau_crawling"/>
        <result property="priority" column="sau_priority"/>
        <result property="times" column="sau_times"/>
        <result property="url" column="sau_url"/>
        <result property="parentUrl" column="sau_parent_url"/>
        <result property="extra" column="sau_extra"/>
        <result property="createTime" column="sau_create_time"/>
        <result property="updateTime" column="sau_update_time"/>
    </resultMap>


    <insert id="add" parameterType="Url">
        insert into spider_amazon_url(
        sau_url_md5,bo_batch_num,sau_type,bas_code,saa_asin,sau_review_id,sau_status,sau_crawling,sau_priority,sau_times,sau_url,sau_parent_url,sau_extra)
        values(#{urlMD5},#{batchNum},#{type},#{siteCode},#{asin},#{reviewId},#{status},#{crawling},#{priority},#{times},#{url},#{parentUrl},#{extra})
    </insert>

    <insert id="addAll" parameterType="java.util.List">
        INSERT INTO spider_amazon_url(
        sau_url_md5,bo_batch_num,sau_type,bas_code,saa_asin,sau_review_id,sau_status,sau_crawling,sau_priority,sau_times,sau_url,sau_parent_url,sau_extra)
        values
        <foreach collection="list" item="item" index="index" separator=",">
            (
            #{item.urlMD5},#{item.batchNum},#{item.type},#{item.siteCode},#{item.asin},#{item.reviewId},#{item.status},
            #{item.crawling},#{item.priority},#{item.times},#{item.url},#{item.parentUrl},#{item.extra}
            )
        </foreach>
    </insert>

    <update id="update" parameterType="Url">
        UPDATE spider_amazon_url SET
        bo_batch_num = #{batchNum},sau_type=#{type},bas_code = #{siteCode},saa_asin=#{asin},sau_review_id=#{reviewId},sau_status = #{status},
        sau_crawling=#{crawling},sau_priority=#{priority},sau_times=#{times},sau_url = #{url},sau_parent_url=#{parentUrl},sau_extra=#{extra}
        WHERE sau_url_md5 = #{urlMD5}
    </update>

    <select id="findByType" resultMap="UrlResultMap" parameterType="int">
        SELECT * FROM spider_amazon_url
        WHERE
        sau_status != 200
        AND sau_type = #{0}
        AND sau_crawling = 0
        ORDER BY
        sau_priority LIMIT 15;
    </select>

    <!-- 根据ASIN码查询全量爬取的URL -->
    <select id="findByAsin" resultMap="UrlResultMap">
        SELECT * FROM spider_amazon_url WHERE bo_batch_num = #{0} and bas_code = #{1} AND saa_asin = #{2} AND sau_type = 1;
    </select>

    <!--查询某个ASIN更新爬取的URL列表-->
    <select id="findUpdateCrawl" resultMap="UrlResultMap">
        SELECT * FROM spider_amazon_url WHERE bo_batch_num = #{0} AND bas_code = #{1} AND saa_asin = #{2} AND sau_type = 2;
    </select>

    <delete id="delete" parameterType="int">
        DELETE FROM spider_amazon_url WHERE sau_id = #{0};
    </delete>

    <delete id="deleteByAsin" parameterType="String">
        DELETE FROM spider_amazon_url WHERE bas_code = #{0} and saa_asin = #{1};
    </delete>

    <delete id="deleteByType" parameterType="int">
        DELETE FROM spider_amazon_url WHERE sau_type = #{0};
    </delete>

    <select id="find" resultMap="UrlResultMap">
        SELECT * FROM spider_amazon_url WHERE sau_url_md5 = #{0};
    </select>

    <select id="findByUrlMd5" resultMap="UrlResultMap">
        select * from spider_amazon_url
        WHERE sau_url_md5 = #{0};
    </select>

    <select id="findByBatchNum" resultMap="UrlResultMap">
        select * from spider_amazon_url
        WHERE bo_batch_num = #{0};
    </select>

    <!-- 设置URL的状态为未爬取 -->
    <update id="resetStatus">
        UPDATE spider_amazon_url SET sau_crawling = 0;
    </update>

    <!-- 根据Url的Md5值删除单条Url -->
    <delete id="deleteByUrlMd5">
        DELETE FROM spider_amazon_url WHERE sau_url_md5 = #{0};
    </delete>

    <delete id="deleteOne">
        DELETE FROM spider_amazon_url WHERE bo_batch_num = #{0} and bas_code = #{1} and saa_asin = #{2}
    </delete>

    <update id="updatePriority">
        UPDATE spider_amazon_url SET sau_priority = #{1} WHERE saa_asin = #{0};
    </update>

    <update id="updateMonitorPriority">
        UPDATE spider_amazon_url SET sau_priority = #{1} WHERE sau_review_id = #{0};
    </update>

</mapper>