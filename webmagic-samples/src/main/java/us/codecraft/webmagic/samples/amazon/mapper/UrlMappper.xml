<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="us.codecraft.webmagic.samples.amazon.dao.UrlDao">

    <resultMap id="UrlResultMap" type="Url">
        <result property="id" column="sau_id"/>
        <result property="urlMD5" column="sau_url_md5"/>
        <result property="siteCode" column="BAS_CODE"/>
        <result property="type" column="sau_type"/>
        <result property="saaAsin" column="saa_asin"/>
        <result property="sauReviewId" column="sau_review_id"/>
        <result property="status" column="sau_status"/>
        <result property="sauCrawling" column="sau_crawling"/>
        <result property="priority" column="sau_priority"/>
        <result property="url" column="sau_url"/>
        <result property="parentUrl" column="sau_parent_url"/>
        <result property="postParams" column="sau_post_params"/>
        <result property="headers" column="sau_headers"/>
        <result property="cookies" column="sau_cookies"/>
        <result property="otherParams" column="sau_other_params"/>
        <result property="extra" column="sau_extra"/>
        <result property="updatetime" column="sau_update_time"/>
    </resultMap>

    <insert id="add" parameterType="Url">
        <selectKey resultType="java.lang.Long">
            SELECT @@IDENTITY AS id
        </selectKey>
        insert into spider_amazon_url(sau_url_md5,BAS_CODE,sau_type,saa_asin,sau_review_id,
        sau_status,sau_crawling,sau_priority,sau_url,sau_parent_url,sau_post_params,sau_headers,sau_cookies,sau_other_params,sau_extra)
        values(#{urlMD5},#{siteCode},#{type},#{saaAsin},#{sauReviewId},#{status},#{sauCrawling},#{priority},#{url},#{parentUrl},#{postParams},#{headers},#{cookies},#{otherParams},#{extra})
        ON DUPLICATE KEY UPDATE sau_url_md5 = #{urlMD5},sau_type = #{type}
    </insert>

    <insert id="addAll" parameterType="java.util.List">
        <selectKey resultType="java.lang.Long">
            SELECT @@IDENTITY AS id
        </selectKey>
        INSERT INTO spider_amazon_url(sau_url_md5,BAS_CODE,sau_type,saa_asin,sau_review_id,
        sau_status,sau_crawling,sau_priority,sau_url,sau_parent_url,sau_post_params,sau_headers,sau_cookies,sau_other_params,sau_extra)
        values
        <foreach collection="list" item="item" index="index" separator=",">
            (
            #{item.urlMD5},
            #{item.siteCode},#{item.type},
            #{item.saaAsin},#{item.sauReviewId},
            #{item.status},#{item.sauCrawling},#{item.priority},
            #{item.url},#{item.parentUrl},
            #{item.postParams},#{item.headers},
            #{item.cookies},#{item.otherParams},
            #{item.extra}
            )
        </foreach>
        ON DUPLICATE KEY UPDATE
        sau_url_md5 = #{item.urlMD5},
        BAS_CODE = #{item.siteCode},
        sau_type = #{item.type},
        saa_asin = #{item.saaAsin},
        sau_review_id = #{item.sauReviewId},
        sau_status = #{item.status},
        sau_crawling = #{item.sauCrawling},
        sau_priority = #{item.priority},
        sau_url = #{item.url},
        sau_parent_url=#{item.parentUrl},
        sau_post_params=#{item.postParams},
        sau_headers=#{item.headers},
        sau_cookies=#{item.cookies},
        sau_other_params=#{item.otherParams},
        sau_extra=#{item.extra},
        sau_update_time=CURRENT_TIMESTAMP
    </insert>

    <update id="update" parameterType="Url">
        insert into spider_amazon_url(sau_url_md5,BAS_CODE,sau_type,saa_asin,sau_review_id,
        sau_status,sau_crawling,sau_priority,sau_url,sau_parent_url,sau_post_params,sau_headers,sau_cookies,sau_other_params,sau_extra)
        values(#{urlMD5},#{siteCode},#{type},#{saaAsin},#{sauReviewId},#{status},#{sauCrawling},#{priority},#{url},#{parentUrl},#{postParams},#{headers},#{cookies},#{otherParams},#{extra})
        ON DUPLICATE KEY UPDATE sau_url_md5 = #{urlMD5},BAS_CODE = #{siteCode},sau_type=#{type},saa_asin=#{saaAsin},sau_review_id=#{sauReviewId},sau_status = #{status},sau_crawling=#{sauCrawling},sau_priority=#{priority},sau_url =
        #{url},sau_parent_url=#{parentUrl},sau_post_params=#{postParams},sau_headers=#{headers},sau_cookies=#{cookies},sau_other_params=#{otherParams},sau_extra=#{extra},sau_update_time=CURRENT_TIMESTAMP
    </update>

    <select id="findByType" resultMap="UrlResultMap" parameterType="int">
        SELECT * FROM spider_amazon_url WHERE sau_status != 200 AND sau_type = #{0} AND sau_crawling = 0 ORDER BY sau_priority LIMIT 10;
    </select>

    <!-- 根据ASIN码查询全量爬取的URL -->
    <select id="findByAsin" resultMap="UrlResultMap">
        SELECT * FROM spider_amazon_url WHERE saa_asin = #{0} AND sau_type = 0;
    </select>

    <!--查询某个ASIN更新爬取的URL列表-->
    <select id="findUpdateCrawl" resultMap="UrlResultMap">
        SELECT * FROM spider_amazon_url WHERE saa_asin = #{0} AND sau_type = 2;
    </select>

    <!--查询被监听的的URL列表-->
    <select id="findMonitorUrlList" resultMap="UrlResultMap">
        SELECT * FROM spider_amazon_url WHERE sau_type = 1;
    </select>

    <delete id="delete" parameterType="int">
        DELETE FROM spider_amazon_url WHERE sau_id = #{0};
    </delete>

    <delete id="deleteByAsin" parameterType="String">
        DELETE FROM spider_amazon_url WHERE saa_asin = #{0};
    </delete>

</mapper>