<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="us.codecraft.webmagic.samples.amazon.dao.AsinDao">

    <resultMap id="AsinResultMap" type="Asin">
        <result property="saaAsin" column="saa_asin"/>
        <result property="saaStar" column="saa_star"/>
        <result property="saaStatus" column="saa_status"/>
        <result property="saaParsed" column="saa_parsed"/>
        <result property="saaPriority" column="saa_priority"/>
        <result property="extra" column="saa_extra"/>
        <result property="saaSyncTime" column="saa_sync_time"/>
        <result property="createtime" column="saa_create_time"/>
        <result property="updatetime" column="saa_update_time"/>

        <association property="asinSource" resultMap="AsinSourceResultMap"/>
        <association property="site" resultMap="SiteResultMap"/>
    </resultMap>

    <resultMap id="AsinSourceResultMap" type="AsinSource">
        <result property="baasCode" column="BAAS_CODE"/>
        <result property="baasName" column="baas_name"/>
        <result property="createtime" column="baas_create_time"/>
        <result property="updatetime" column="baas_update_time"/>
    </resultMap>

    <resultMap id="SiteResultMap" type="Site">
        <result property="basCode" column="BAS_CODE"/>
        <result property="basSite" column="bas_site"/>
        <result property="basName" column="bas_name"/>
        <result property="basCrawl" column="bas_crawl"/>
        <result property="createtime" column="bas_create_time"/>
        <result property="updatetime" column="bas_update_time"/>
    </resultMap>

    <!--获取指定星级的数据-->
    <select id="find" resultMap="AsinResultMap">
        SELECT * FROM spider_amazon_asin asin
        INNER JOIN base_amazon_asin_source asinSource ON asinSource.BAAS_CODE = asin.BAAS_CODE
        INNER JOIN base_amazon_site site ON asin.BAS_CODE = site.BAS_CODE
        WHERE asin.saa_star = #{0}
    </select>

    <!-- 查询所有记录 -->
    <select id="findAll" resultMap="AsinResultMap">
        SELECT * FROM spider_amazon_asin asin
        INNER JOIN base_amazon_asin_source asinSource ON asinSource.BAAS_CODE = asin.BAAS_CODE
        INNER JOIN base_amazon_site site ON asin.BAS_CODE = site.BAS_CODE WHERE saa_parsed = 0
    </select>

    <!--更新爬取状态和URL转换状态-->
    <update id="update" parameterType="Asin">
        UPDATE spider_amazon_asin SET saa_status = #{saaStatus},saaParsed=#{saa_parsed},saa_update_time=#{updatetime} WHERE saa_asin = #{saaAsin}
    </update>

    <update id="updateSyncTime" parameterType="Asin">
        UPDATE spider_amazon_asin SET saa_sync_time=#{saaSyncTime} WHERE saa_asin = #{saaAsin}
    </update>

</mapper>