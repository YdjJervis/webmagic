<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.eccang.spider.amazon.dao.crawl.ReviewDao">

    <cache eviction="LRU" type="com.eccang.spider.base.service.RedisCacheService"/>

    <resultMap id="ReviewResultMap" type="Review">
        <result property="siteCode" column="bas_code"/>
        <result property="rootAsin" column="rar_root_asin"/>
        <result property="personId" column="sar_person_id"/>
        <result property="time" column="sar_time"/>
        <result property="dealTime" column="sar_deal_time"/>
        <result property="person" column="sar_person"/>
        <result property="reviewId" column="sar_review_id"/>
        <result property="monitor" column="sar_monitor"/>
        <result property="buyStatus" column="sar_buy_status"/>
        <result property="star" column="sar_star"/>
        <result property="version" column="sar_version"/>
        <result property="title" column="sar_title"/>
        <result property="content" column="sar_content"/>
        <result property="votes" column="sar_votes"/>
        <result property="extra" column="sar_extra"/>
        <result property="pageNum" column="sar_page_num"/>
        <result property="createTime" column="sar_create_time"/>
        <result property="updateTime" column="sar_update_time"/>
    </resultMap>

    <resultMap id="BatchAsinExtraResultMap" type="BatchAsinExtra">
        <result property="reviewID" column="sar_review_id"/>
        <result property="star" column="sar_star"/>
    </resultMap>

    <resultMap id="StarReviewCountMap" type="StarReviewCount">
        <result property="star" column="sar_star"/>
        <result property="count" column="count"/>
    </resultMap>

    <insert id="add" parameterType="Review">
        insert into spider_amazon_review(
        bas_code,rar_root_asin,sar_person_id,sar_time,sar_deal_time,sar_person,sar_review_id,sar_monitor,sar_buy_status,sar_star,
        sar_version,sar_title,sar_content,sar_votes,sar_extra,sar_page_num)
        values
        (#{siteCode},#{rootAsin},#{personId},#{time},#{dealTime},#{person},#{reviewId},#{monitor},#{buyStatus},#{star},#{version},#{title},
        #{content},#{votes},#{extra},#{pageNum})
    </insert>

    <insert id="addAll" parameterType="java.util.List">
        insert into spider_amazon_review
        (bas_code,rar_root_asin,sar_person_id,sar_time,sar_deal_time,sar_person,sar_review_id,sar_monitor,sar_buy_status,sar_star,
        sar_version,sar_title,sar_content,sar_votes,sar_extra,sar_page_num)
        values
        <foreach collection="list" item="item" index="index" separator=",">
            (#{item.siteCode},#{item.rootAsin},#{item.personId},#{item.time},#{item.dealTime},#{item.person},#{item.reviewId},
            #{item.monitor},#{item.buyStatus},#{item.star},#{item.version},#{item.title},#{item.content},#{item.votes},#{item.extra},#{item.pageNum})
        </foreach>
    </insert>

    <update id="update" parameterType="Review">
        UPDATE spider_amazon_review SET
        rar_root_asin=#{rootAsin},sar_person_id=#{personId},sar_time=#{time},sar_deal_time=#{dealTime},sar_person=#{person},
        sar_monitor=#{monitor},sar_buy_status=#{buyStatus},sar_star=#{star},sar_version=#{version},sar_title=#{title},sar_content=#{content},
        sar_votes=#{votes},sar_extra=#{extra},sar_page_num=#{pageNum}
        WHERE sar_review_id = #{reviewId}
    </update>

    <!--根据评论Id查找Review-->
    <select id="findByReviewId" resultMap="ReviewResultMap">
        SELECT * FROM spider_amazon_review WHERE sar_review_id = #{0};
    </select>

    <!--根据ASIN找需要爬取的星级最新一条评论的时间-->
    <select id="findLastReview" resultMap="ReviewResultMap">
        SELECT tmp.* FROM (SELECT * FROM spider_amazon_review WHERE rar_root_asin = #{0} ORDER BY sar_create_time ASC) tmp GROUP BY tmp.sar_star;
    </select>

    <!-- 查询每个星级对应的评论数量 -->
    <select id="findStarReviewCount" resultMap="StarReviewCountMap">
        SELECT sar_star,COUNT(*) as count FROM spider_amazon_review WHERE rar_root_asin = #{0} GROUP BY sar_star;
    </select>

    <select id="findAll" resultMap="ReviewResultMap" parameterType="Review">
        SELECT * FROM spider_amazon_review WHERE
        rar_root_asin = #{rootAsin} and
        <if test="personId != null">
            sar_person_id = #{personId} and
        </if>
        <if test='experience != null'>
            <choose>
              <when test='experience.equals("yes")'>
                sar_buy_status is not null and
              </when>
              <otherwise>
                  sar_buy_status is null and
              </otherwise>
            </choose>
        </if>
        sar_star in
        <foreach collection="starList" index="index" item="item" separator="," open="(" close=")">
            #{item}
        </foreach>
        LIMIT #{pageNum},#{pageSize}
    </select>

    <select id="findAllCount" resultType="int" parameterType="Review">
        SELECT COUNT(*) FROM spider_amazon_review WHERE
        rar_root_asin = #{rootAsin} and
        <if test="personId != null">
            sar_person_id = #{personId} and
        </if>
        <if test='experience != null'>
            <choose>
                <when test='experience.equals("yes")'>
                    sar_buy_status is not null and
                </when>
                <otherwise>
                    sar_buy_status is null and
                </otherwise>
            </choose>
        </if>
        sar_star in
        <foreach collection="starList" index="index" item="item" separator="," open="(" close=")">
            #{item}
        </foreach>
    </select>

    <!-- 根据RootASIN和星级查询Review列表 -->
    <select id="findAllByStar" resultMap="BatchAsinExtraResultMap">
        SELECT sar_review_id,sar_star FROM spider_amazon_review WHERE
            rar_root_asin = #{0} and sar_star = #{1} order by sar_deal_time DESC;
    </select>

    <select id="findByIdAndRootAsin" resultMap="ReviewResultMap">
          SELECT * FROM spider_amazon_review
          WHERE
          sar_review_id = #{0} AND rar_root_asin = #{1}
    </select>
</mapper>