<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.eccang.spider.amazon.dao.batch.BatchAsinDao">

    <cache eviction="LRU" type="com.eccang.spider.base.rediscache.RedisCache"/>

    <resultMap id="BatchAsinResultMap" type="BatchAsin">
        <result property="id" column="boa_id"/>
        <result property="batchNumber" column="bo_batch_num"/>
        <result property="siteCode" column="bas_code"/>
        <result property="asin" column="boa_asin"/>
        <result property="rootAsin" column="boa_root_asin"/>
        <result property="priority" column="boa_priority"/>
        <result property="star" column="boa_star"/>
        <result property="crawled" column="boa_crawled"/>
        <result property="status" column="boa_status"/>
        <result property="progress" column="boa_progress"/>
        <result property="type" column="boa_type"/>
        <result property="isChanged" column="boa_is_changed"/>
        <result property="extra" column="boa_extra"/>
        <result property="startTime" column="boa_start_time"/>
        <result property="finishTime" column="boa_finish_time"/>
        <result property="createTime" column="boa_create_time"/>
        <result property="updateTime" column="boa_update_time"/>
    </resultMap>

    <select id="findByCode" resultMap="BatchAsinResultMap">
        SELECT * FROM batch_order_asin WHERE bo_batch_num = #{0};
    </select>

    <select id="findAllByAsin" resultMap="BatchAsinResultMap">
        SELECT * FROM batch_order_asin WHERE bo_batch_num = #{0} and bas_code = #{1} AND boa_asin = #{2};
    </select>

    <select id="findAllByBatchNum" resultMap="BatchAsinResultMap">
        SELECT * FROM batch_order_asin WHERE bo_batch_num = #{0};
    </select>

    <select id="find" parameterType="BatchAsin" resultMap="BatchAsinResultMap">
        SELECT * FROM batch_order_asin WHERE bo_batch_num = #{batchNumber} AND bas_code = #{siteCode} AND boa_asin = #{asin};
    </select>

    <select id="findByStatus" resultMap="BatchAsinResultMap">
        SELECT * FROM batch_order_asin WHERE boa_status = #{0};
    </select>

    <!-- 查询某个单号的平均进度 -->
    <select id="findAverageProgress" resultType="float">
        SELECT SUM(boa_progress)/COUNT(*) FROM batch_order_asin WHERE bo_batch_num = #{0};
    </select>

    <select id="findNotCrawledMainPage" resultMap="BatchAsinResultMap">
        SELECT * FROM batch_order_asin WHERE boa_status = 0 and boa_type = 0;
    </select>

    <select id="findNotCrawledReview" resultMap="BatchAsinResultMap">
        SELECT * FROM batch_order_asin WHERE boa_status = 2 and boa_type = 1;
    </select>

    <select id="findNotUpdatedReview" resultMap="BatchAsinResultMap">
        SELECT * FROM batch_order_asin WHERE boa_status = 4 and boa_type = 2;
    </select>

    <update id="update" parameterType="BatchAsin">
        UPDATE batch_order_asin SET
        boa_root_asin = #{rootAsin},
        boa_priority = #{priority},
        boa_star = #{star},
        boa_crawled = #{crawled},
        boa_status = #{status},
        boa_progress = #{progress},
        boa_type = #{type},
        boa_is_changed = #{isChanged},
        boa_extra = #{extra},
        boa_start_time = #{startTime},
        boa_finish_time = #{finishTime}
        WHERE
        bo_batch_num = #{batchNumber} AND bas_code = #{siteCode} AND boa_asin = #{asin};
    </update>

    <insert id="addAll" parameterType="java.util.List">
        INSERT INTO batch_order_asin(
        bo_batch_num,bas_code,boa_asin,boa_root_asin,boa_priority,boa_star,boa_crawled,boa_status,boa_progress,
        boa_type,boa_is_changed,boa_extra,boa_start_time,boa_finish_time
        )
        VALUES
        <foreach collection="list" item="item" index="index" separator=",">
            (
            #{item.batchNumber},#{item.siteCode},#{item.asin},#{item.rootAsin},#{item.priority},#{item.star},#{item.crawled},#{item.status},#{item.progress},
            #{item.type},#{item.isChanged},#{item.extra},#{item.startTime},#{item.finishTime}
            )
        </foreach>
    </insert>

</mapper>